name: 📁 Update a Single Dataset

on:
  workflow_dispatch:
    inputs:
      dataset:
        description: "Name of the dataset (required)"
        required: true
        default: dcp_mappluto
      latest:
        type: boolean
        description: "Tag this version as latest (optional)"
        required: false
        default: "true"
      version:
        description: "The version of the dataset (i.e. 22v2, 21C) if needed (optional)"
        required: false

jobs:
  setup:
    uses: ./.github/workflows/setup.yml
  dataloading:
    runs-on: ubuntu-20.04
    steps:
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: myimage
          path: /tmp
      - name: Load Docker image
        run: |
          docker load --input /tmp/myimage.tar
      - name: Archive ${{ github.event.inputs.dataset }}
        env:
          latest: ${{ github.event.inputs.latest == 'true' && '--latest' || ' ' }}
          version: ${{ github.event.inputs.version || ' ' }}
        run: |
          echo $latest
          echo $version
          poetry run library archive --name ${{ github.event.inputs.dataset }} -o pgdump --s3 --compress $latest $version
          poetry run library archive --name ${{ github.event.inputs.dataset }} -o shapefile --s3 --compress $latest $version
          poetry run library archive --name ${{ github.event.inputs.dataset }} -o csv --s3 --compress $latest $version
          
